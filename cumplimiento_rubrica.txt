Estás dentro del repo de una app Flutter.
Ya corriste un análisis previo y el estado actual es este:

.github/workflows/cd-firebase.yml:

Tiene on: push a main y workflow_dispatch.

Instala Flutter (subosito/flutter-action) y Java 17.

Corre flutter pub get.

Instala Ruby/fastlane y llama a bundle exec fastlane cd_firebase.

❌ No hace pasos de firma (no decodifica ANDROID_KEYSTORE_BASE64, no genera android/key.properties, no exporta passwords).

❌ No hace flutter build appbundle --release, solo delega a una lane que compila APK debug.

Android signing:

android/key.properties NO existe.

android/app/build.gradle.kts usa signingConfigs.getByName("debug") en release.

No define storeFile/storePassword/keyAlias/keyPassword ni referencia a android/app/release.keystore.

No hay keystore en el repo ni pasos en workflows para generarlo/decodificarlo.

Fastlane:

Existe fastlane/Fastfile con una lane cd_firebase.

Esa lane ejecuta flutter build apk --debug y sube build/app/outputs/flutter-apk/app-debug.apk.

❌ No genera AAB release ni lo publica.

Depende de FIREBASE_APP_ID_ANDROID / FIREBASE_TOKEN, pero no usa service account JSON.

Firebase App Distribution:

Ningún workflow exporta GOOGLE_APPLICATION_CREDENTIALS.

No se consume FIREBASE_SERVICE_ACCOUNT_JSON.

Usa firebase_cli_token en lugar del JSON de cuenta de servicio.

Solo se usa el secret FIREBASE_APP_ID_ANDROID.

Rutas/artefactos:

El pipeline apunta al APK debug (build/app/outputs/flutter-apk/app-debug.apk).

❌ Debería usar el AAB release (build/app/outputs/bundle/release/app-release.aab).

iOS:

No hay ios/fastlane, ni lanes deliver/upload_to_testflight. (Por ahora iOS es opcional.)

Documentación/capturas:

No hay carpeta de evidencias con capturas del pipeline ni de Firebase AD.

🎯 Objetivo

Quiero que modifiques el repo para que:

Android release + firma correcta

Use un keystore configurado mediante android/key.properties.

build.gradle.kts tenga signingConfigs para release usando esas properties.

buildTypes.release use signingConfigs["release"] y deje de reutilizar debug.

Fastlane (lane “beta” o similar)

Haya una lane que:

Corra flutter build appbundle --release.

Use el plugin firebase_app_distribution para subir el AAB a Firebase App Distribution.

Use FIREBASE_APP_ID_ANDROID y un JSON de service account (GOOGLE_APPLICATION_CREDENTIALS apuntando a un archivo que contenga el contenido de FIREBASE_SERVICE_ACCOUNT_JSON).

Workflow .github/workflows/cd-firebase.yml

Decodifique el keystore desde el secret ANDROID_KEYSTORE_BASE64 y lo guarde en android/app/release.keystore.

Genere android/key.properties con estos valores, que vendrán de GitHub Secrets:

ANDROID_KEYSTORE_PASSWORD

ANDROID_KEY_PASSWORD

ANDROID_KEY_ALIAS

Escriba el JSON de la service account en un archivo (ej. $HOME/gcp-sa.json) usando el secret FIREBASE_SERVICE_ACCOUNT_JSON.

Exporte GOOGLE_APPLICATION_CREDENTIALS apuntando a ese archivo.

Exporte FIREBASE_APP_ID_ANDROID desde secrets.

Llame a la lane de fastlane correcta (beta o renombrada), que construya el AAB release y lo suba a Firebase AD.

Mantenga on: push a main y workflow_dispatch.

Rutas

La lane de fastlane debe usar:

aab_path: "build/app/outputs/bundle/release/app-release.aab"

NO debe seguir usando el APK debug.

NO commitear secretos

No escribas valores reales, solo asume que los secrets existen en GitHub:

ANDROID_KEYSTORE_BASE64

ANDROID_KEYSTORE_PASSWORD

ANDROID_KEY_PASSWORD

ANDROID_KEY_ALIAS

FIREBASE_SERVICE_ACCOUNT_JSON

FIREBASE_APP_ID_ANDROID

(opcional) FIREBASE_TESTERS o similar para el campo testers en Firebase AD.

🛠 Cambios concretos que quiero que hagas
1) android/app/build.gradle.kts

Si ya hay bloque android { ... }, modifícalo para que:

Declare algo como:

val keystoreProperties = Properties().apply {
    val keystorePropertiesFile = rootProject.file("android/key.properties")
    if (keystorePropertiesFile.exists()) {
        load(keystorePropertiesFile.inputStream())
    }
}


Dentro de android { signingConfigs { ... } } crea un release:

signingConfigs {
    create("release") {
        storeFile = file(keystoreProperties["storeFile"] as String)
        storePassword = keystoreProperties["storePassword"] as String
        keyAlias = keystoreProperties["keyAlias"] as String
        keyPassword = keystoreProperties["keyPassword"] as String
    }
}


Dentro de buildTypes { getByName("release") { ... } }:

Usa signingConfig = signingConfigs.getByName("release").

Asegúrate de que no dependa de debug.

Ajusta solo lo necesario, sin romper otras configuraciones.

2) Crear android/key.properties (solo plantilla, sin secrets)

Crea el archivo android/key.properties de ejemplo, con valores de placeholder, tipo:

storePassword=YOUR_STORE_PASSWORD
keyPassword=YOUR_KEY_PASSWORD
keyAlias=YOUR_KEY_ALIAS
storeFile=release.keystore


Deja un comentario arriba aclarando que en CI se sobrescribe con los valores de GitHub Secrets.

3) fastlane/Fastfile

Mantén la lane actual cd_firebase si es útil, pero crea o ajusta una lane para producción/beta, por ejemplo:

default_platform(:android)

platform :android do
  desc "CD Firebase: build AAB release y subir a Firebase App Distribution"
  lane :beta do
    sh("flutter pub get")
    sh("flutter build appbundle --release")

    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      testers: ENV["FIREBASE_TESTERS"],
      release_notes: "Build automática desde GitHub Actions",
      aab_path: "build/app/outputs/bundle/release/app-release.aab"
    )
  end
end


Usa el plugin firebase_app_distribution y asume que el auth se hace vía GOOGLE_APPLICATION_CREDENTIALS (cuenta de servicio).

Si hace falta, agrega el Gemfile o la configuración necesaria para firebase_app_distribution, pero solo si es estrictamente necesario y consistente con el repo actual.

4) .github/workflows/cd-firebase.yml

Modifica el workflow para que:

Decode keystore:

- name: Decode keystore
  run: echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
  env:
    ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}


Crear android/key.properties:

- name: Configure key.properties
  run: |
    cat > android/key.properties <<EOF
    storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
    keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
    keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
    storeFile=release.keystore
    EOF


Service account JSON (Firebase):

- name: Write Firebase service account JSON
  run: echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > $HOME/gcp-sa.json

- name: Export env vars
  run: |
    echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-sa.json" >> $GITHUB_ENV
    echo "FIREBASE_APP_ID_ANDROID=${{ secrets.FIREBASE_APP_ID_ANDROID }}" >> $GITHUB_ENV
    echo "FIREBASE_TESTERS=${{ secrets.FIREBASE_TESTERS }}" >> $GITHUB_ENV


Llamar a la lane correcta:

Cambia el paso que ahora hace bundle exec fastlane cd_firebase para que ejecute:

- name: Run fastlane beta
  run: bundle exec fastlane beta


No elimines nada útil del workflow, solo adáptalo para cumplir la rúbrica: AAB release + firma + Firebase App Distribution con service account.

📦 Forma de entrega (cómo quiero que respondas)

Respóndeme con:

Lista de archivos modificados/creados.

Para cada archivo, un diff estilo unified (diff --git ...) listo para copiar/pegar si lo necesito.

Breve explicación de cada cambio (una línea por archivo).

Si algo no se puede hacer por falta de contexto, explica qué falta.

No hagas comentarios genéricos; aplica directamente los cambios al código del rep